name: $(date:yyyy).$(date:MM).$(date:dd)$(rev:.r) # versioning

stages:
- stage: Build
  displayName: Build Stage
  variables:
    imageName: 'dml.corp.payroc.com/release-docker-local/pcen/pcen-app-underwritingws'
    tagName: 'latest'
  jobs:
  - job: build_and_push_image
    displayName: Build and Push Docker Image
    pool: onprem-linux-elksdx
    steps:
    - checkout: self
      submodules: true

    - task: Docker@2
      displayName: "Build Docker Image"
      inputs:
        command: build
        dockerfile: $(Build.SourcesDirectory)/Dockerfile
        repository: $(imageName)
        buildContext: $(Build.SourcesDirectory)
        tags: $(tagName)

    - task: JFrogDocker@1
      displayName: "Push Docker image to Artifactory"
      condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
      inputs:
        command: 'Push'
        artifactoryConnection: 'devops_dml-Engineering'
        imageName: '$(imageName):$(tagName)'
        targetRepo: 'release-docker-local/pcen'